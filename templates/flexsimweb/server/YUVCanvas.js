!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.YUVCanvas=b()}(this,function(){function a(a){a=a||{},this.canvasElement=a.canvas||document.createElement("canvas"),this.contextOptions=a.contextOptions,this.type=a.type||"yuv420",this.customYUV444=a.customYUV444,this.conversionType=a.conversionType||"rec601",this.width=a.width||640,this.height=a.height||320,this.animationTime=a.animationTime||0,this.canvasElement.width=this.width,this.canvasElement.height=this.height,this.initContextGL(),this.contextGL&&(this.initProgram(),this.initBuffers(),this.initTextures()),"yuv420"===this.type?this.drawNextOuptutPictureGL=function(a){var b=this.contextGL,c=this.texturePosBuffer,d=this.uTexturePosBuffer,e=this.vTexturePosBuffer,f=this.yTextureRef,g=this.uTextureRef,h=this.vTextureRef,i=a.yData,j=a.uData,k=a.vData,l=this.width,m=this.height,n=a.yDataPerRow||l,o=a.yRowCnt||m,p=a.uDataPerRow||l/2,q=a.uRowCnt||m/2,r=a.vDataPerRow||p,s=a.vRowCnt||q;b.viewport(0,0,l,m);var t=0,u=0,v=m/o,w=l/n,x=new Float32Array([w,t,u,t,w,v,u,v]);b.bindBuffer(b.ARRAY_BUFFER,c),b.bufferData(b.ARRAY_BUFFER,x,b.DYNAMIC_DRAW),this.customYUV444?(v=m/q,w=l/p):(v=m/2/q,w=l/2/p);var y=new Float32Array([w,t,u,t,w,v,u,v]);b.bindBuffer(b.ARRAY_BUFFER,d),b.bufferData(b.ARRAY_BUFFER,y,b.DYNAMIC_DRAW),this.customYUV444?(v=m/s,w=l/r):(v=m/2/s,w=l/2/r);var z=new Float32Array([w,t,u,t,w,v,u,v]);b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,z,b.DYNAMIC_DRAW),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,f),b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,n,o,0,b.LUMINANCE,b.UNSIGNED_BYTE,i),b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,g),b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,p,q,0,b.LUMINANCE,b.UNSIGNED_BYTE,j),b.activeTexture(b.TEXTURE2),b.bindTexture(b.TEXTURE_2D,h),b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,r,s,0,b.LUMINANCE,b.UNSIGNED_BYTE,k),b.drawArrays(b.TRIANGLE_STRIP,0,4)}:"yuv422"===this.type&&(this.drawNextOuptutPictureGL=function(a){var b=this.contextGL,c=this.texturePosBuffer,d=this.textureRef,e=a.data,f=this.width,g=this.height,h=a.dataPerRow||2*f,i=a.rowCnt||g;b.viewport(0,0,f,g);var j=0,k=0,l=g/i,m=f/(h/2),n=new Float32Array([m,j,k,j,m,l,k,l]);b.bindBuffer(b.ARRAY_BUFFER,c),b.bufferData(b.ARRAY_BUFFER,n,b.DYNAMIC_DRAW),b.uniform2f(b.getUniformLocation(this.shaderProgram,"resolution"),h,g),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,d),b.texImage2D(b.TEXTURE_2D,0,b.LUMINANCE,h,i,0,b.LUMINANCE,b.UNSIGNED_BYTE,e),b.drawArrays(b.TRIANGLE_STRIP,0,4)})}return a.prototype.isWebGL=function(){return this.contextGL},a.prototype.initContextGL=function(){for(var a=this.canvasElement,b=null,c=["webgl","experimental-webgl","moz-webgl","webkit-3d"],d=0;!b&&d<c.length;){var e=c[d];try{b=this.contextOptions?a.getContext(e,this.contextOptions):a.getContext(e)}catch(a){b=null}b&&"function"==typeof b.getParameter||(b=null),++d}this.contextGL=b},a.prototype.initProgram=function(){var b,c,a=this.contextGL;"yuv420"===this.type?(b=["attribute vec4 vertexPos;","attribute vec4 texturePos;","attribute vec4 uTexturePos;","attribute vec4 vTexturePos;","varying vec2 textureCoord;","varying vec2 uTextureCoord;","varying vec2 vTextureCoord;","void main()","{","  gl_Position = vertexPos;","  textureCoord = texturePos.xy;","  uTextureCoord = uTexturePos.xy;","  vTextureCoord = vTexturePos.xy;","}"].join("\n"),c=["precision highp float;","varying highp vec2 textureCoord;","varying highp vec2 uTextureCoord;","varying highp vec2 vTextureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","uniform mat4 YUV2RGB;","void main(void) {","  highp float y = texture2D(ySampler,  textureCoord).r;","  highp float u = texture2D(uSampler,  uTextureCoord).r;","  highp float v = texture2D(vSampler,  vTextureCoord).r;","  gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n")):"yuv422"===this.type&&(b=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","  gl_Position = vertexPos;","  textureCoord = texturePos.xy;","}"].join("\n"),c=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D sampler;","uniform highp vec2 resolution;","uniform mat4 YUV2RGB;","void main(void) {","  highp float texPixX = 1.0 / resolution.x;","  highp float logPixX = 2.0 / resolution.x;","  highp float logHalfPixX = 4.0 / resolution.x;","  highp float steps = floor(textureCoord.x / logPixX);","  highp float uvSteps = floor(textureCoord.x / logHalfPixX);","  highp float y = texture2D(sampler, vec2((logPixX * steps) + texPixX, textureCoord.y)).r;","  highp float u = texture2D(sampler, vec2((logHalfPixX * uvSteps), textureCoord.y)).r;","  highp float v = texture2D(sampler, vec2((logHalfPixX * uvSteps) + texPixX + texPixX, textureCoord.y)).r;","  gl_FragColor = vec4(y, u, v, 1.0) * YUV2RGB;","}"].join("\n"));var d=[];d="rec709"==this.conversionType?[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1]:[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1];var e=a.createShader(a.VERTEX_SHADER);a.shaderSource(e,b),a.compileShader(e),a.getShaderParameter(e,a.COMPILE_STATUS)||console.log("Vertex shader failed to compile: "+a.getShaderInfoLog(e));var f=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(f,c),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)||console.log("Fragment shader failed to compile: "+a.getShaderInfoLog(f));var g=a.createProgram();a.attachShader(g,e),a.attachShader(g,f),a.linkProgram(g),a.getProgramParameter(g,a.LINK_STATUS)||console.log("Program failed to compile: "+a.getProgramInfoLog(g)),a.useProgram(g);var h=a.getUniformLocation(g,"YUV2RGB");a.uniformMatrix4fv(h,!1,d),this.shaderProgram=g},a.prototype.initBuffers=function(){var a=this.contextGL,b=this.shaderProgram,c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),a.STATIC_DRAW);var d=a.getAttribLocation(b,"vertexPos");if(a.enableVertexAttribArray(d),a.vertexAttribPointer(d,2,a.FLOAT,!1,0,0),this.animationTime){var e=this.animationTime,f=0,g=15,h=function(){f+=g;var c=1*f/e;f>=e?c=1:setTimeout(h,g);var d=-1*c,i=1*c,j=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,j),a.bufferData(a.ARRAY_BUFFER,new Float32Array([i,i,d,i,i,d,d,d]),a.STATIC_DRAW);var k=a.getAttribLocation(b,"vertexPos");a.enableVertexAttribArray(k),a.vertexAttribPointer(k,2,a.FLOAT,!1,0,0);try{a.drawArrays(a.TRIANGLE_STRIP,0,4)}catch(a){}};h()}var i=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,i),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),a.STATIC_DRAW);var j=a.getAttribLocation(b,"texturePos");if(a.enableVertexAttribArray(j),a.vertexAttribPointer(j,2,a.FLOAT,!1,0,0),this.texturePosBuffer=i,"yuv420"===this.type){var k=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,k),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),a.STATIC_DRAW);var l=a.getAttribLocation(b,"uTexturePos");a.enableVertexAttribArray(l),a.vertexAttribPointer(l,2,a.FLOAT,!1,0,0),this.uTexturePosBuffer=k;var m=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,m),a.bufferData(a.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),a.STATIC_DRAW);var n=a.getAttribLocation(b,"vTexturePos");a.enableVertexAttribArray(n),a.vertexAttribPointer(n,2,a.FLOAT,!1,0,0),this.vTexturePosBuffer=m}},a.prototype.initTextures=function(){var a=this.contextGL,b=this.shaderProgram;if("yuv420"===this.type){var c=this.initTexture(),d=a.getUniformLocation(b,"ySampler");a.uniform1i(d,0),this.yTextureRef=c;var e=this.initTexture(),f=a.getUniformLocation(b,"uSampler");a.uniform1i(f,1),this.uTextureRef=e;var g=this.initTexture(),h=a.getUniformLocation(b,"vSampler");a.uniform1i(h,2),this.vTextureRef=g}else if("yuv422"===this.type){var i=this.initTexture(),j=a.getUniformLocation(b,"sampler");a.uniform1i(j,0),this.textureRef=i}},a.prototype.initTexture=function(){var a=this.contextGL,b=a.createTexture();return a.bindTexture(a.TEXTURE_2D,b),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),b},a.prototype.drawNextOutputPicture=function(a,b,c,d){var e=this.contextGL;e?this.drawNextOuptutPictureGL(a,b,c,d):this.drawNextOuptutPictureRGBA(a,b,c,d)},a.prototype.drawNextOuptutPictureRGBA=function(a,b,c,d){var e=this.canvasElement,c=null,f=d,g=e.getContext("2d"),h=g.getImageData(0,0,a,b);h.data.set(f),null===c?g.putImageData(h,0,0):g.putImageData(h,-c.left,-c.top,0,0,c.width,c.height)},a});